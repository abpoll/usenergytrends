{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(stringr)\n\ncons <- read.csv(\"/Users/Adam/usenergytrends/data/use_US.csv\")\nstate_cons <- read.csv(\"/Users/Adam/usenergytrends/data/Complete_SEDS.csv\")\n\n#total consumption rows, butane units only\nstate_total_cons <- state_cons[grepl(\"TC\", state_cons$MSN),]\nstate_total_consb <- state_total_cons[grepl(\"B\", state_total_cons$MSN), ]\n\n#total final consumption rows, butane units only\nstate_total_fcons <- state_cons[grepl(\"TX\", state_cons$MSN),]\nstate_total_fconsb <- state_total_fcons[grepl(\"B\", state_total_fcons$MSN), ]\n\n#1990 and 2015 only for comparisons\nstc_comp <- state_total_consb[grepl(\"1990|2015\", state_total_consb$Year), ]\nstfc_comp <- state_total_fconsb[grepl(\"1990|2015\", state_total_fconsb$Year), ]\n\n#REMOVE DC, per Prof. instructions\nstc_comp <- stc_comp[stc_comp$StateCode != 'DC',]\nstfc_comp <- stfc_comp[stfc_comp$StateCode != 'DC',]\n\n##Map MSN to its full phrase\ncodes <- read.csv(\"/Users/Adam/usenergytrends/data/Codes_and_Descriptions.csv\", skip =9)\ncodes <- select(codes, MSN, Description, Unit)\ncodes <- codes[grepl(\"TC|TX\", codes$MSN),]\ncodes <- codes[grepl(\"B\", codes$MSN),] #57 codes to go through\nrownames(codes) <- NULL\n#paste((codes %>% filter(MSN == 'TETCB'))$Description) \n#use this for 'mapping' the msn code for plotting, tables, etc\n\n#percent change function\npct <- function(x) {diff(x)/x[1:length(diff(x))] * 100}\n\n## Function to get df of states with % change from year to year for given MSN ##\n#The data frame input is in EIA format for energy consumption data. \n#A specific value for MSN is given along with the df\n#Then, for given years in the df for each state\n#a % change is calculated and stored for each row\n#The final df will be state-years-%change\nstates.perc.change <- function(cons_frame, msn){\n  \n  ##Store change in total consumption for each code in a df for normalizing later\n  normalize <- cons_frame[str_sub(cons_frame$MSN, 1, 3) == 'TET',]\n  normalize <- normalize %>% group_by(StateCode) %>% summarize(Change = diff(Data))\n  \n  #hold the string list of states and US\n  states <- as.character(unique(cons_frame$StateCode)) \n  \n  #subset the MSN values of interest from the dataframe\n  msn_frame <- subset(cons_frame,grepl(msn, as.character(cons_frame$MSN)))\n  years <- msn_frame %>% distinct(Year)\n  \n  #Create the string MSN-BaseYr-CompYr\n  comp <- paste(as.character(years[,1][1]), as.character(years[,1][2]), sep=\"-\")\n  msn <- codes$Description[codes$MSN == msn]\n  comp <- paste(msn, comp, sep=\" \")\n  #Get perc. change for each state\n  perc_change <- msn_frame %>% group_by(StateCode) %>% summarize(PercentChange = pct(Data))\n  #Get diff. for each state\n  change <- msn_frame %>% group_by(StateCode) %>% summarize(Change = diff(Data))\n  \n  #Join together\n  perc_changes <- merge(perc_change, change)\n  \n  #Rename and finalize data structure\n  rename(perc_changes, Location=StateCode)\n  perc_changes <- perc_changes %>% rowwise() %>% mutate(Comparison=comp)\n  \n  #Move US to bottom of df for later use\n  top = perc_changes[-grep(\"US\", as.character(perc_changes$StateCode)),]\n  bottom = perc_changes[grep(\"US\", as.character(perc_changes$StateCode)),]\n  perc_changes <- rbind(top, bottom)\n  \n  return(perc_changes)\n}\n\n\n#Method review\n#states.perc.change(stc_comp, 'WYTCB') %>% filter(!is.nan(PercChange), is.finite(PercChange))\n#Only 5 States, and US as whole have non 0 1990 wind value\n#Need to divide into categories - Perc. Change, Growth (maybe a log scale of growth), and No Progress\n#So a column can also be returned in above method that returns the diff\n\n#filter(!is.finite(PercentChange), !is.nan(PercentChange)) relative growth states\n#filter(is.nan(PercentChange)) non mover states\n\n##Function that takes in the states data frame of PercentChange, Change, Comparison\n#and writes a figure for %changers and relative changers (and a string for non changers)\n#to a file (ie MSN_1990_2015 will be folder where MSN will be fuly written out and\n#files will be titled appropriately)\nstates.change.plots <- function(change_frame){\n  changers <- change_frame %>% filter(!is.nan(PercentChange))\n  zero_nochange <- change_frame %>% filter(is.nan(PercentChange))\n  \n  movers_x <- which(is.finite(changers$PercentChange))\n  movers_y <- changers[movers_x,]$PercentChange\n  \n  #Print out the list of states w/ 0 cons. in base and comp. year\n  cat(cat(\"The Following States have 0 Consumption in 1990 and 2015: \"), \n      cat(as.character(t2$StateCode), sep=\", \"))\n  \n  logChange = log2(changers$Change)\n  #figure out how to plot by index while still printing state code so \n  #US is all the way at the right. Or, color it differently for now. \n  ggplot(changers, aes(x=StateCode, y = logChange)) + geom_col()\n  \n  #Title should come from the Comparison entry \n}\n\n",
    "created" : 1516229002528.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3055746415",
    "id" : "F7E35ECC",
    "lastKnownWriteTime" : 1517951940,
    "last_content_update" : 1517951940521,
    "path" : "~/usenergytrends/workbooks/consumption/consumption.R",
    "project_path" : "consumption.R",
    "properties" : {
        "docOutlineVisible" : "0",
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}